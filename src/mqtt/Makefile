# A simple local MQTT broker for Horizon servcies to use

# ----------------------------------------------------------------------------

-include ../../env.check.mk

# You must always use the Horizon name for architecture (`hzn architecture`)
export ARCH ?= $(shell hzn architecture)

# Import variables from hzn.json (file is generated by last target in this file)
-include .hzn.json.tmp.mk

# ----------------------------------------------------------------------------

# Build the docker container
build:
	docker build -t $(DOCKER_IMAGE_BASE)_$(ARCH):$(SERVICE_VERSION) -f ./Dockerfile.$(ARCH) .

# Push the docker container to the DockerHub registry
push:
	docker push $(DOCKER_IMAGE_BASE)_$(ARCH):$(SERVICE_VERSION)

# Publish a Horizon service (per service.json) and pull image to get its sha256
publish-service:
	hzn exchange service publish -f service.json --pull-image

# Remove the local container image
clean:
	@docker rmi $(DOCKER_IMAGE_BASE)_$(ARCH):$(SERVICE_VERSION) 2>/dev/null || :
	@rm -f .hzn.json.tmp.mk

# ----------------------------------------------------------------------------

# Perform a quick self-test
# - Verified on ubuntu and Rapsbian
# - NOTE: requires `mosquito-clients` package to be installed on the host
# - do this to test:
#    1. start a broker instance: `make test-broker`
#    2. in one terminal on the host, subscribe with: `make test-sub`
#    3. then in another termninal on the host, publish with: `make test-pub`
#    4. You should see `Hello, world.` appear in the subscribed terminal
#    5. Terminate the subscriber with Ctrl-C, then: `make test-end`
test-broker:
	@docker network create mqtt-net 2>/dev/null || :
	-docker rm -f test-broker 2>/dev/null || :
	docker run --rm -d -p 127.0.0.1:1883:1883 --name test-broker --network mqtt-net --network-alias mqtt $(DOCKER_IMAGE_BASE)_$(ARCH):$(SERVICE_VERSION)
test-sub:
	mosquitto_sub -h 127.0.0.1 -p 1883 -t /foo
test-pub:
	mosquitto_pub -h 127.0.0.1 -p 1883 -t /foo -m 'Hello, world.'
test-end:
	docker rm -f test-broker

# ----------------------------------------------------------------------------

# This imports the variables from hzn.json
.hzn.json.tmp.mk: hzn.json
	@ hzn util configconv -f $< > $@

